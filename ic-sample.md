# 1.读卡函数  
  功能：读出卡内数据，包括用户卡号、气量等。  
  ```
  int __stdcall ReadGasCardshort com, long baud,short *klx, short *kzt, char *kh,char *tm, INT32 *ql, INT32 *cs,INT32 *ljgql, INT32 *bkcs, INT32 *ljyql, INT32 *syql);
  ```
  参数：
  ```
  串口号（IN）
  波特率（IN）
  卡类型（OUT）
  卡状态（OUT）:未上过表的用户卡,该字段为０，否则为１
  用户卡号（OUT）: 对于新卡，该字段
  表条码（OUT）：上表后的用户卡，表条码应当为表的表钢号，未上表的新卡，此字段为`????????`
  气量（OUT）: 上次购气量
  购气次数（OUT）: 累计购气次数
  累计购气量（OUT）: 如表累计购气30方，则该字段值为30
  补卡次数（OUT）：白卡的补卡次数为０，上过一次表的卡的补卡次数为１
  表内累计用气量（OUT）: 写卡后该值为0,否则为表内累计用气量，如表内累计计用气30方，该值应为3000
  表内剩余气量（OUT): 写卡后该值为0,否则为表内剩余气量，如表内剩余气30方，该值应为3000
  ```
另外，(表内累计用气量/100+表内剩余气量/100)的值域为: [累计购气量,累计购气量-1]

  返回值：

  ```
  0：操作成功。
  其它值：操作失败，见“返回值定义”。  
  ```


# 2.写新卡函数  
  功能：将开户卡或用户卡数据写入已格式化的新卡中。根据卡类型和卡状态确定写数据的格式。用户卡号、气量是必须使用的参数。  
  ```
  int __stdcall WriteNewCard(short com, INT32 baud,short klx, short kzt, unsigned char *kh,unsigned char *tm, INT32 ql, short cs,INT32 ljgql, short bkcs, INT32 ljyql); 
  ```
  参数：
  ```
  串口号（IN）
  波特率（IN）
  卡类型（IN）
  卡状态（IN）
  用户卡号（IN）
  表条码（IN）
  气量（IN）
  购气次数（IN）
  累计购气量（IN）
  补卡次数（IN）
  表内累计用气量（IN）
  ```
  返回值：
  ```
  0：操作成功；
  其它值：操作失败，见“返回值定义”。
  ```


# 3.写用户卡函数  
  功能：用于用户卡购气、退气。气量大于0代表购气，气量等于0代表退气。需要验证卡内的用户卡号和地区代码是否与传入的参数值(kh,dqdm)相符合，不符合不能进行写入操作。若卡内没有地区代码，则只需要验证用户卡号相符合。用户卡号、气量是必须使用的参数。    
  ```
  int __stdcall WriteGasCard(short com, INT32 baud, short klx, unsigned char *kh,INT16 ql,short cs,INT32 ljgql);;
  ```
  参数：
  ```
  串口号（IN）
  波特率（IN）
  卡类型（IN）
  用户卡号（IN）
  气量（IN）
  购气次数（IN）
  累计购气量（IN）
  ```
  返回值：
  ```
  0：操作成功；
  其它值：操作失败，见“返回值定义”。  
  ```


# 4.清卡函数  
  功能：将开户卡或用户卡格式化成新卡。需要验证卡内的用户卡号和地区代码是否与传入的参数值(kh,dqdm)相符合，不符合不能进行格式化操作。若卡内没有地区代码，则只需要验证用户卡号相符合。  
  ```
  int __stdcall FormatGasCard (short com, INT32 baud);
  ```
  参数：
  ```
  串口号（IN）
  波特率（IN）
  ```
  返回值：
  ```
  0：操作成功；
  其它值：操作失败，见“返回值定义”。  
  ```


# 5.判卡函数  
  功能：根据卡片中的特征信息，识别插入的卡片是否为本厂商驱动支持的开户卡或用户卡，不需要识别新卡。在读卡过程中，应避免多次尝试读卡密码造成卡报废。  
  ```
  int __stdcall CheckGasCard(__int16 com, __int32 baud);
  ```
  参数：
  ```
  串口号（IN）
  波特率（IN）  
  ```
  返回值：
  ```
  0：本厂商驱动支持的开户卡或用户卡；
  1：本厂商的工具卡；
  其它值：操作失败，见“返回值定义”。
  ```

# 6.清0卡函数  
  功能：把表上的数据清0.  
  ```
  int makeInitCard(short com, long baud,short klx,unsigned char *kh);
  ```
  参数:
  ```
  串口号(IN)
  波特率(IN)
  卡类型(IN)
  卡号(IN)
  ```
  返回值：
  ```
  0：成功
  其他值见返回定义
  ```


# 返回值：  
```
-1	不是注册用户(对于有需要注册才可以使用的动态库的厂商)
-2	端口初始化失败　　　:没插读卡器返回该值
-3	读设备状态失败　
-4	无卡
-5	读卡密码次数失败
-6	该卡已经损坏
-7	读卡错误　　　:没有插卡返回该值
-8	该卡不是用户卡　　　：不是用户卡（工具卡，如清表卡）返回该值
-9	核对密码错误
-10	写卡失败
-11	备份气量不正确
-12	关闭通讯端口失败
-13	该卡可能是新卡或插反　　：卡插反了，新卡，坏卡返回该值
-14	该卡非本系统卡
-15	该卡不是新卡(只有写新卡函数需要返回该值。)
-16	用户卡号（地区代码）与卡内的值不匹配
-17	清卡失败
-18	气量超限
-19至-30	上位机系统保留返回值
```
# 业务流程

## 发用户卡

发卡前系统先调用清卡函数，之后调用制卡函数，制卡函数传递的参数有:

- 卡类型
- 卡状态：０
- 卡号：系统生成的８位数卡号，如：12345678
- 条码：空字符串: ''
- 气量：本次发卡气量
- 购气次数：１
- 累计购气量: 　等于气量
- 补卡次数：０
- 表内累计用气量：０
-  表内剩余气量：０

如果是补卡操作，那么：

- 卡类型
- 卡状态：如果未上表的新卡，等于０，否则为１
- 卡号
- 条码：如果是未上表的新卡，等于空字符串: ''．如果是上过表的卡，则为该表的条码号
- 气量
- 购气次数：不变
- 累计购气量
- 补卡次数：上次的+1，如果是新卡应当为２
- 表内累计用气量：０
-  表内剩余气量：０

## 写卡

系统不允许都卡内有气但是未上表的IC卡进行再次写卡，写卡通过调用写卡函数完成，传递的参数如下：

- 卡类型
- 卡号
- 气量：本次发卡气量
- 购气次数:　上次购气次数+1
- 累计购气量

## 清卡

直接调用清卡函数，不传递任何参数

## 发清表卡

调用清０卡函数，传递参数：

- 卡类型
- 卡号
